{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Car Listings - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .listing-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .listing-header {
        margin-bottom: 30px;
    }

    .listing-header h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #1a1a1a;
    }

    .results-count {
        color: #666;
        font-size: 14px;
    }

    .listing-layout {
        display: flex;
        gap: 30px;
    }

    /* Sidebar Filters */
    .filters-sidebar {
        width: 280px;
        flex-shrink: 0;
    }

    .filter-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .filter-section h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #1a1a1a;
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-group:last-child {
        margin-bottom: 0;
    }

    .filter-group label {
        display: block;
        font-size: 14px;
        color: #333;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
    }

    .filter-group input:focus,
    .filter-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .apply-filters-btn {
        width: 100%;
        padding: 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
    }

    .apply-filters-btn:hover {
        background: #0056b3;
    }

    .clear-filters-btn {
        width: 100%;
        padding: 10px;
        background: transparent;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.3s;
        text-decoration: none;
        display: block;
        text-align: center;
    }

    .clear-filters-btn:hover {
        background: #007bff;
        color: white;
    }

    /* Main Content */
    .listings-main {
        flex: 1;
        min-width: 0;
    }

    .listings-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .results-info {
        font-size: 14px;
        color: #666;
    }

    .sort-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sort-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
        cursor: pointer;
    }

    /* Car Grid */
    .cars-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .car-card {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
        position: relative;
    }

    .car-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .car-image {
        position: relative;
        width: 100%;
        height: 220px;
        overflow: hidden;
        background: #f5f5f5;
    }

    .car-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }

    .car-card:hover .car-image img {
        transform: scale(1.05);
    }

    .car-badges {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 2;
    }

    .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }

    .badge-featured {
        background: #ff6b6b;
        color: white;
    }

    .badge-urgent {
        background: #ffc107;
        color: #1a1a1a;
    }

    .badge-new {
        background: #28a745;
        color: white;
    }

    .favorite-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        background: rgba(255,255,255,0.95);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        z-index: 2;
    }

    .favorite-btn:hover {
        background: white;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .favorite-btn svg {
        width: 20px;
        height: 20px;
        fill: none;
        stroke: #ff6b6b;
        stroke-width: 2;
    }

    .favorite-btn.active svg {
        fill: #ff6b6b;
    }

    .car-details {
        padding: 18px;
    }

    .car-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
        min-height: 50px;
    }

    .car-title:hover {
        color: #007bff;
    }

    .car-price {
        font-size: 24px;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 12px;
    }

    .car-price small {
        font-size: 14px;
        color: #666;
        font-weight: 400;
    }

    .car-specs {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
        font-size: 13px;
        color: #666;
        flex-wrap: wrap;
    }

    .spec-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .spec-item svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .car-location {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
        color: #999;
        margin-bottom: 12px;
    }

    .car-location svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
    }

    .car-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid #f0f0f0;
    }

    .seller-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .seller-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: 600;
    }

    .seller-name {
        font-size: 13px;
        color: #666;
    }

    .view-btn-card {
        padding: 8px 16px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        transition: background 0.3s;
        display: inline-block;
    }

    .view-btn-card:hover {
        background: #0056b3;
        color: white;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 40px;
        padding: 20px;
    }

    .page-link {
        padding: 8px 14px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        color: #333;
        text-decoration: none;
        transition: all 0.3s;
        font-size: 14px;
    }

    .page-link:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .page-link.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .page-link.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        color: #ccc;
    }

    .empty-state h3 {
        font-size: 20px;
        color: #666;
        margin-bottom: 10px;
    }

    .empty-state p {
        color: #999;
        margin-bottom: 20px;
    }

    .empty-state a {
        display: inline-block;
        padding: 10px 24px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        transition: background 0.3s;
    }

    .empty-state a:hover {
        background: #0056b3;
    }

    /* Mobile Toggle */
    .mobile-filter-toggle {
        display: none;
        width: 100%;
        padding: 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 20px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .mobile-filter-toggle:hover {
        background: #0056b3;
    }

    .filter-close-btn {
        display: none;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .cars-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .listing-container {
            padding: 15px;
        }

        .listing-layout {
            flex-direction: column;
        }

        .mobile-filter-toggle {
            display: block;
        }

        .filters-sidebar {
            display: none;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .filters-sidebar.active {
            display: block;
        }

        .filter-close-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: #f5f5f5;
            border: none;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .cars-grid {
            grid-template-columns: 1fr;
        }

        .listings-toolbar {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .sort-container {
            width: 100%;
        }

        .sort-select {
            width: 100%;
        }

        .listing-header h1 {
            font-size: 22px;
        }

        .car-specs {
            flex-wrap: wrap;
            gap: 10px;
        }

        .car-footer {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .view-btn-card {
            width: 100%;
            text-align: center;
        }
    }

    @media (max-width: 480px) {
        .car-card {
            border-radius: 8px;
        }

        .car-image {
            height: 200px;
        }

        .car-title {
            font-size: 16px;
            min-height: 45px;
        }

        .car-price {
            font-size: 20px;
        }

        .car-specs {
            font-size: 12px;
            gap: 8px;
        }

        .spec-item svg {
            width: 14px;
            height: 14px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="listing-container">
    <!-- Header -->
    <div class="listing-header">
        <h1>
            {% if search_query %}
                Search Results for "{{ search_query }}"
            {% else %}
                New & Used Cars for Sale
            {% endif %}
        </h1>
        <p class="results-count">{{ total_cars }} car{% if total_cars != 1 %}s{% endif %} found</p>
    </div>

    <!-- Mobile Filter Toggle -->
    <button class="mobile-filter-toggle" onclick="toggleFilters()">
        <svg style="display:inline; width:16px; height:16px; margin-right:8px; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        Filters & Search
    </button>

    <div class="listing-layout">
        <!-- Filters Sidebar -->
        <aside class="filters-sidebar" id="filtersSidebar">
            <button class="filter-close-btn" onclick="toggleFilters()">âœ• Close Filters</button>
            
            <form method="get" action="" id="filterForm">
                <!-- Search -->
                <div class="filter-section">
                    <h3>Search</h3>
                    <div class="filter-group">
                        <input type="text" name="q" placeholder="Search by make, model..." value="{{ search_query }}">
                    </div>
                </div>

                <!-- Make -->
                <div class="filter-section">
                    <h3>Make</h3>
                    <div class="filter-group">
                        <select name="make">
                            <option value="">All Makes</option>
                            {% for make in makes %}
                                <option value="{{ make.slug }}" {% if current_filters.make == make.slug %}selected{% endif %}>
                                    {{ make.name }} ({{ make.car_count }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Body Type -->
                <div class="filter-section">
                    <h3>Body Type</h3>
                    <div class="filter-group">
                        <select name="body_type">
                            <option value="">All Body Types</option>
                            {% for value, label in body_types %}
                                <option value="{{ value }}" {% if current_filters.body_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Condition -->
                <div class="filter-section">
                    <h3>Condition</h3>
                    <div class="filter-group">
                        <select name="condition">
                            <option value="">All Conditions</option>
                            {% for value, label in conditions %}
                                <option value="{{ value }}" {% if current_filters.condition == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Price Range -->
                <div class="filter-section">
                    <h3>Price Range</h3>
                    <div class="filter-group">
                        <label>Min Price (KES)</label>
                        <input type="number" name="price_min" placeholder="Min" value="{{ current_filters.price_min }}" step="10000">
                    </div>
                    <div class="filter-group">
                        <label>Max Price (KES)</label>
                        <input type="number" name="price_max" placeholder="Max" value="{{ current_filters.price_max }}" step="10000">
                    </div>
                </div>

                <!-- Year Range -->
                <div class="filter-section">
                    <h3>Year</h3>
                    <div class="filter-group">
                        <label>Min Year</label>
                        <input type="number" name="year_min" placeholder="Min" value="{{ current_filters.year_min }}" min="1900" max="2025">
                    </div>
                    <div class="filter-group">
                        <label>Max Year</label>
                        <input type="number" name="year_max" placeholder="Max" value="{{ current_filters.year_max }}" min="1900" max="2025">
                    </div>
                </div>

                <!-- Fuel Type -->
                <div class="filter-section">
                    <h3>Fuel Type</h3>
                    <div class="filter-group">
                        <select name="fuel_type">
                            <option value="">All Fuel Types</option>
                            {% for value, label in fuel_types %}
                                <option value="{{ value }}" {% if current_filters.fuel_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Transmission -->
                <div class="filter-section">
                    <h3>Transmission</h3>
                    <div class="filter-group">
                        <select name="transmission">
                            <option value="">All Transmissions</option>
                            {% for value, label in transmissions %}
                                <option value="{{ value }}" {% if current_filters.transmission == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Mileage Range -->
                <div class="filter-section">
                    <h3>Mileage (km)</h3>
                    <div class="filter-group">
                        <label>Min Mileage</label>
                        <input type="number" name="mileage_min" placeholder="Min" value="{{ current_filters.mileage_min }}" step="1000">
                    </div>
                    <div class="filter-group">
                        <label>Max Mileage</label>
                        <input type="number" name="mileage_max" placeholder="Max" value="{{ current_filters.mileage_max }}" step="1000">
                    </div>
                </div>

                <!-- City -->
                <div class="filter-section">
                    <h3>Location</h3>
                    <div class="filter-group">
                        <select name="city">
                            <option value="">All Cities</option>
                            {% for city in cities %}
                                <option value="{{ city }}" {% if current_filters.city == city %}selected{% endif %}>
                                    {{ city }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Hidden sort field -->
                <input type="hidden" name="sort" value="{{ current_filters.sort }}">

                <button type="submit" class="apply-filters-btn">Apply Filters</button>
                <a href="?" class="clear-filters-btn">Clear All Filters</a>
            </form>
        </aside>

        <!-- Main Listings -->
        <main class="listings-main">
            <!-- Toolbar -->
            <div class="listings-toolbar">
                <div class="results-info">
                    {% if page_obj %}
                        Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_cars }}
                    {% else %}
                        Showing 0 cars
                    {% endif %}
                </div>
                <div class="sort-container">
                    <select class="sort-select" onchange="updateSort(this.value)">
                        <option value="-created_at" {% if current_filters.sort == '-created_at' %}selected{% endif %}>Newest First</option>
                        <option value="price" {% if current_filters.sort == 'price' %}selected{% endif %}>Price: Low to High</option>
                        <option value="-price" {% if current_filters.sort == '-price' %}selected{% endif %}>Price: High to Low</option>
                        <option value="mileage" {% if current_filters.sort == 'mileage' %}selected{% endif %}>Mileage: Low to High</option>
                        <option value="-year" {% if current_filters.sort == '-year' %}selected{% endif %}>Year: Newest</option>
                        <option value="year" {% if current_filters.sort == 'year' %}selected{% endif %}>Year: Oldest</option>
                    </select>
                </div>
            </div>

            <!-- Cars Grid -->
            {% if cars %}
            <div class="cars-grid">
                {% for car in cars %}
                <div class="car-card">
                    <div class="car-image">
                        <a href="{% url 'car_detail' car.slug %}">
                            {% if car.images.all %}
                                <img src="{{ car.images.first.image.url }}" alt="{{ car.title }}" loading="lazy">
                            {% else %}
                                <img src="{% static 'images/no-car-image.jpg' %}" alt="{{ car.title }}" loading="lazy">
                            {% endif %}
                        </a>
                        
                        <div class="car-badges">
                            {% if car.is_featured %}
                                <span class="badge badge-featured">Featured</span>
                            {% endif %}
                            {% if car.is_urgent %}
                                <span class="badge badge-urgent">Urgent</span>
                            {% endif %}
                            {% if car.condition == 'brand_new' %}
                                <span class="badge badge-new">Brand New</span>
                            {% endif %}
                        </div>
                        
                        <button class="favorite-btn {% if car.id in favorite_car_ids %}active{% endif %}" 
                                onclick="toggleFavorite({{ car.id }}, this)" 
                                data-car-id="{{ car.id }}"
                                aria-label="Add to favorites">
                            <svg viewBox="0 0 24 24">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="car-details">
                        <a href="{% url 'car_detail' car.slug %}" style="text-decoration:none; color:inherit;">
                            <h3 class="car-title">{{ car.title }}</h3>
                        </a>
                        
                        <div class="car-price">
                            KES {{ car.price|floatformat:0|intcomma }}
                            {% if car.negotiable %}
                                <small>(Negotiable)</small>
                            {% endif %}
                        </div>
                        
                        <div class="car-specs">
                            <span class="spec-item">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                {{ car.year }}
                            </span>
                            <span class="spec-item">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                {{ car.mileage|intcomma }} km
                            </span>
                            <span class="spec-item">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                {{ car.get_transmission_display }}
                            </span>
                        </div>
                        
                        <div class="car-location">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            {{ car.city }}, {{ car.country }}
                        </div>
                        
                        <div class="car-footer">
                            <div class="seller-info">
                                {% if car.dealer %}
                                    <div class="seller-avatar">
                                        {% if car.dealer.business_name %}
                                            {{ car.dealer.business_name|first|upper }}
                                        {% else %}
                                            D
                                        {% endif %}
                                    </div>
                                    <span class="seller-name">{{ car.dealer.business_name }}</span>
                                {% else %}
                                    <div class="seller-avatar">
                                        {{ car.seller.username|first|upper }}
                                    </div>
                                    <span class="seller-name">{{ car.seller.username }}</span>
                                {% endif %}
                            </div>
                            <a href="{% url 'car_detail' car.slug %}" class="view-btn-card">View Details</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">First</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Previous</a>
                {% else %}
                    <span class="page-link disabled">First</span>
                    <span class="page-link disabled">Previous</span>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="page-link active">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">{{ num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Last</a>
                {% else %}
                    <span class="page-link disabled">Next</span>
                    <span class="page-link disabled">Last</span>
                {% endif %}
            </div>
            {% endif %}
            
            {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3>No cars found</h3>
                <p>Try adjusting your filters or search criteria</p>
                <a href="?">Clear Filters</a>
            </div>
            {% endif %}
        </main>
    </div>
</div>

<script>
function toggleFilters() {
    const sidebar = document.getElementById('filtersSidebar');
    const closeBtn = sidebar.querySelector('.filter-close-btn');
    const body = document.body;
    
    sidebar.classList.toggle('active');
    
    if (window.innerWidth <= 768) {
        closeBtn.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        
        // Prevent body scroll when sidebar is open on mobile
        if (sidebar.classList.contains('active')) {
            body.style.overflow = 'hidden';
        } else {
            body.style.overflow = '';
        }
    }
}

function updateSort(sortValue) {
    const url = new URL(window.location.href);
    url.searchParams.set('sort', sortValue);
    url.searchParams.set('page', '1'); // Reset to first page
    window.location.href = url.toString();
}

function toggleFavorite(carId, button) {
    {% if user.is_authenticated %}
        fetch(`/cars/${carId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'added') {
                button.classList.add('active');
            } else if (data.status === 'removed') {
                button.classList.remove('active');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update favorite. Please try again.');
        });
    {% else %}
        window.location.href = '/accounts/login/?next={{ request.path }}';
    {% endif %}
}

// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle responsive sidebar
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('filtersSidebar');
    const body = document.body;
    
    if (window.innerWidth > 768) {
        sidebar.classList.remove('active');
        body.style.overflow = '';
    }
});

// Close sidebar when clicking outside on mobile
document.addEventListener('click', function(event) {
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('filtersSidebar');
        const toggleBtn = document.querySelector('.mobile-filter-toggle');
        
        if (sidebar.classList.contains('active') && 
            !sidebar.contains(event.target) && 
            !toggleBtn.contains(event.target)) {
            toggleFilters();
        }
    }
});

// Prevent clicks inside sidebar from closing it
document.getElementById('filtersSidebar').addEventListener('click', function(event) {
    event.stopPropagation();
});
</script>
{% endblock %}